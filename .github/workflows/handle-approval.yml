# Handle approval comments on issues
name: Handle Approval Comments

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  process:
    # Only run on issues (not PRs) with approval-required label
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.issue.labels.*.name, 'approval-required')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./
        id: process
        with:
          action: process-comment
          issue_number: ${{ github.event.issue.number }}
          token: ${{ secrets.GITHUB_TOKEN }}
          config_repo: RogueCloud/.github

      - name: Handle Result
        env:
          STATUS: ${{ steps.process.outputs.status }}
          APPROVERS: ${{ steps.process.outputs.approvers }}
          DENIER: ${{ steps.process.outputs.denier }}
          TAG: ${{ steps.process.outputs.tag }}
          GROUP: ${{ steps.process.outputs.satisfied_group }}
        run: |
          echo "## Approval Processing Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${STATUS}" >> $GITHUB_STEP_SUMMARY

          if [ "${STATUS}" = "approved" ]; then
            echo "- **Approvers:** ${APPROVERS}" >> $GITHUB_STEP_SUMMARY
            echo "- **Satisfied Group:** ${GROUP}" >> $GITHUB_STEP_SUMMARY
            if [ -n "${TAG}" ]; then
              echo "- **Tag Created:** ${TAG}" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${STATUS}" = "denied" ]; then
            echo "- **Denied by:** ${DENIER}" >> $GITHUB_STEP_SUMMARY
          fi
